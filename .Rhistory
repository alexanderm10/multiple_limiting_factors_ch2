install.packages("dplR")
install.packages("lattice")
install.packages("maps")
install.packages(c("raster", "rgdal", "ggplot2", "reshape2", "plyr"))
library(raster)
library(rgdal)
library(ggplot2)
library(reshape2)
library(plyr)
install.packages("devtools")
devtools::install_github("rstudio/packrat")
install.packages("kohonen")
library("kohonen")
data("wines")
View(wines)
wines.sc <- scale(wines)
set.seed(7)
wine.som <- som(data = wines.sc, grid = somgrid(5, 4, "hexagonal"))
plot(wine.som, main = "Wine data")
library("Hmisc", lib.loc="/Library/Frameworks/R.framework/Versions/3.1/Resources/library")
setwd("~/PhD/Carbon Research/multiple_limiting_factors_ch2")
library(mgcv)
library(ggplot2)
library(car)
# Christy's GAMM code
# gam1 <- gamm(Y ~  s(Biomass, bs="cr", k=3, by=PFT) + s(tair, k=k, by=PFT) + s(precipf, k=k, by=PFT) + s(CO2, k=k, by=PFT), random=list(PlotID=~1), data=data)
# Loading in my data
data.use <- read.csv("processed_data/AllSites_tree_plus_climate.csv", header=T)
summary(data.use)
data.use$group <- data.use$Species
data.use$group <- recode(data.use$group, "'CAOV' = 'CARYA'; 'CACO' = 'CARYA';
'CATE' = 'CARYA'; 'ACSAC' = 'ACSA'; 'BEAL' = 'BETULA'; 'BELE' = 'BETULA'; 'QUMU' = 'QUAL'")
data.use$group.plot <- as.factor(paste(data.use$group, data.use$PlotID, sep="."))
# reducing the amount of data for the test runs
sites.use <- c("Harvard", "Howland", "Morgan Monroe State Park", "Oak Openings Toledo", "Missouri Ozark")
test <- data.use[data.use$Site %in% sites.use,]
summary(test)
# Get a list of what predictors & responses I'm using
predictors.all <- c("RW", "tmean", "precip", "Species", "dbh.recon", "Canopy.Class", "spp.plot", "Site", "group", "group.plot")
# Getting rid of observations that have NAs in the important variables
test <- test[complete.cases(test[,predictors.all]),]
test <- test[test$Live.Dead=="LIVE" & !test$Canopy.Class=="F",]
# Subsetting to a set of species that we have enough data to feel good about
#species.use <- c("TSCA", "QURU", "ACRU", "BEAL", "ACSA", "LITU", "QUAL", "CAOV", "CACO", "CATE", "JUVI", "QUVE", "PCRU", "THOC", "PIST")
group.use <- c("ACRU", "ACSA", "BETULA", "CARYA", "FAGR", "FRAX", "PIST", "QUAL", "QURU", "QUVE", "SAAL", "TSCA", "ULRU")
test <- test[test$group %in% group.use,]
summary(test)
summary(test$Live.Dead)
summary(test$Canopy.Class)
# RW <- test$RW
# temp <- test$tmean
# precip <- test$precip
# canopy <- test$Canopy.Class
# size <- test$DBH..cm.
# species <- unique(test$Species)
# library(ggplot2)
# ggplot(data=test) +
# facet_wrap(~PlotID) +
# geom_histogram(aes(x=dbh.recon))
# ggplot(data=test) +
# facet_wrap(~Species) +
# geom_histogram(aes(x=dbh.recon))
# hist(test$dbh.recon)
###################################################
# HERE'S THE GAMM!!!
###################################################
gam1 <- gamm(RW ~ s(tmean, k=3, by=group) + # tmean*Species
s(precip, k=3, by=group) +
s(dbh.recon, k=3, by=group.plot) +
Canopy.Class,
random=list(Site=~1, PlotID=~1),
data=test)
save(gam1, file="processed_data/gam1_climate_by_species.Rdata")
n <- 100
source("0_Calculate_GAMM_Posteriors.R")
# Fitting our model to the data to see if we're doing a pasable job of capturing the variance
# If things don't match, we shoudl take our sensitiivty curves with a grain of salt
model.pred <- post.distns(model.gam=gam1, model.name="species_response", newdata=test, vars=predictors.all, n=n, terms=F)
summary(model.pred$ci)
model.pred$mean.site <- aggregate(model.pred$RW, by=data.use[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
model.pred$mean.site <- aggregate(model.pred$RW, by=model.pred[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
(model.pred$RW
model.pred$RW
summary(model.pred)
model.pred$ci[RW]
model.pred$ci[["RW"]]
model.pred$ci[, c("group", "Site", "Year")]
model.pred$ci["RW"]
model.pred$ci["mean.site"] <- aggregate(model.pred$ci["RW"], by=model.pred$ci[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
model.pred$ci["mean.site"] <- aggregate(model.pred$ci["RW"], by=model.pred$ci["RW"][, c("group", "Site", "Year")], FUN=mean, na.rm=T)
model.pred$ci["RW"]
mean.rw <- aggregate(data.use$RW, by=data.use[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
names(mean.rw)[names(mean.rw)=="x"]<- c("rw.mean")
mean.rw[,"rw.lwr"] <- aggregate(data.use$RW, by=data.use[,c("group", "Site", "Year")], FUN=quantile, probs=0.025, na.rm=T)[,"x"]
mean.rw[,"rw.upr"] <- aggregate(data.use$RW, by=data.use[,c("group", "Site", "Year")], FUN=quantile, probs=0.975, na.rm=T)[,"x"]
head(mean.rw)
mean.rw <- mean.rw[mean.rw$Site %in% sites.use,]
mean.rw$Species <- mean.rw$group
summary(model.pred$ci)
ggplot(data=mean.rw) + facet_wrap(Species ~ Site, scales="fixed") + theme_bw() +
# plot the data
geom_ribbon(aes(x=Year, ymin=rw.lwr, ymax=rw.upr), alpha=0.5) +
geom_line(aes(x=Year, y=rw.mean), size=1) +
# Plot our model
geom_ribbon(data=model.pred$ci, aes(x=Year, ymin=lwr, ymax=upr), fill="red3", alpha=0.3) +
geom_line(data=model.pred$ci, aes(x=Year, y=mean), color="red3", alpha=0.8, size=1) +
labs(title="Gamm Model vs. Data", x="Year", y="RW")
summary(model.pred2)
model.pred2 <- model.pred$ci
summary(model.pred2)
model.pred2$mean.group <- aggregate(model.pred2$RW, by = model.pred2[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
model.pred2$RW
summary(model.pred2)
dim(model.pred2)
model.pred2[, c("group", "Site", "Year")]
model.pred2$mean.group <- aggregate(model.pred2$RW, by = model.pred2[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
dim(model.pred2)
summary(model.pred2)
aggregate(model.pred2$RW, by = model.pred2[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
test <- aggregate(model.pred2$RW, by = model.pred2[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
model.pred2[,"mean.group"] <- aggregate(model.pred2$RW, by = model.pred2[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
summary(test)
mean.model <- aggregate(model.pred2$RW, by = model.pred2[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
names(mean.model)[names(mean.model)=="x"] <- c("rw.mean")
mean.model[,"rw.lwr"] <- aggregate(data.use$RW, by=data.use[,c("group", "Site", "Year")], FUN=quantile, probs=0.025, na.rm=T)[,"x"]
mean.model[,"rw.upr"] <- aggregate(data.use$RW, by=data.use[,c("group", "Site", "Year")], FUN=quantile, probs=0.975, na.rm=T)[,"x"]
head(mean.model)
mean.model[,"rw.lwr"] <- aggregate(model.pred2$RW, by=model.pred2$RW[,c("group", "Site", "Year")], FUN=quantile, probs=0.025, na.rm=T)[,"x"]
mean.model[,"rw.upr"] <- aggregate(model.pred2$RW, by=model.pred2$RW[,c("group", "Site", "Year")], FUN=quantile, probs=0.975, na.rm=T)[,"x"]
mean.model[,"rw.lwr"] <- aggregate(model.pred2$RW, by=model.pred2[,c("group", "Site", "Year")], FUN=quantile, probs=0.025, na.rm=T)[,"x"]
mean.model[,"rw.upr"] <- aggregate(model.pred2$RW, by=model.pred2[,c("group", "Site", "Year")], FUN=quantile, probs=0.975, na.rm=T)[,"x"]
mean.model[,"rw.lwr"] <- aggregate(model.pred2$RW, by=model.pred2[,c("group", "Site", "Year")], FUN=quantile, probs=0.025, na.rm=T)[,"x"]
mean.model[,"rw.upr"] <- aggregate(model.pred2$RW, by=model.pred2[,c("group", "Site", "Year")], FUN=quantile, probs=0.975, na.rm=T)[,"x"]
head(mean.model)
# aggregating the raw data for graphing
mean.rw <- aggregate(data.use$RW, by=data.use[, c("group", "Site", "Year")], FUN=mean, na.rm=T)
names(mean.rw)[names(mean.rw)=="x"]<- c("rw.mean")
mean.rw[,"rw.lwr"] <- aggregate(data.use$RW, by=data.use[,c("group", "Site", "Year")], FUN=quantile, probs=0.025, na.rm=T)[,"x"]
mean.rw[,"rw.upr"] <- aggregate(data.use$RW, by=data.use[,c("group", "Site", "Year")], FUN=quantile, probs=0.975, na.rm=T)[,"x"]
head(mean.rw)
mean.rw <- mean.rw[mean.rw$Site %in% sites.use,]
mean.rw$Species <- mean.rw$group
ggplot(data=mean.rw) + facet_wrap(Species ~ Site, scales="fixed") + theme_bw() +
# plot the data
geom_ribbon(aes(x=Year, ymin=rw.lwr, ymax=rw.upr), alpha=0.5) +
geom_line(aes(x=Year, y=rw.mean), size=1) +
# Plot our model
geom_ribbon(data=model.mean, aes(x=Year, ymin=rw.lwr, ymax=rw.upr), fill="red3", alpha=0.3) +
geom_line(data=model.mean, aes(x=Year, y=rw.mean), color="red3", alpha=0.8, size=1) +
labs(title="Gamm Model vs. Data", x="Year", y="RW")
ggplot(data=mean.rw) + facet_wrap(Species ~ Site, scales="fixed") + theme_bw() +
# plot the data
geom_ribbon(aes(x=Year, ymin=rw.lwr, ymax=rw.upr), alpha=0.5) +
geom_line(aes(x=Year, y=rw.mean), size=1) +
# Plot our model
geom_ribbon(data=mean.model, aes(x=Year, ymin=rw.lwr, ymax=rw.upr), fill="red3", alpha=0.3) +
geom_line(data=mean.model, aes(x=Year, y=rw.mean), color="red3", alpha=0.8, size=1) +
labs(title="Gamm Model vs. Data", x="Year", y="RW")
